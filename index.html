<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת פענוח כתבי יד - Gemini OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-10 px-4">

    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-xl p-8">
        <h1 class="text-3xl font-bold text-center mb-2 text-blue-600">פענוח כתבי יד באמצעות Gemini</h1>
        <p class="text-center text-gray-500 mb-8">העלו תמונה, הזינו שורת דוגמה לשיפור הדיוק, וקבלו טקסט מפוענח.</p>

        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="apiKey">
                מפתח API של גוגל (Gemini API Key):
            </label>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                   id="apiKey" type="password" placeholder="הדבק כאן את המפתח...">
            <p class="text-xs text-gray-400 mt-1">המפתח נשמר מקומית בדפדפן שלך בלבד.</p>
        </div>

        <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:bg-gray-50 transition">
            <label class="cursor-pointer block">
                <span class="text-gray-600 block mb-2">בחר תמונה לפענוח</span>
                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="previewImage(event)">
                <div id="imagePreviewContainer" class="mt-4 hidden">
                    <img id="imagePreview" class="max-h-64 mx-auto rounded shadow" />
                </div>
            </label>
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="manualLine">
                שורת דוגמה (מומלץ מאוד):
            </label>
            <p class="text-sm text-gray-600 mb-2">אנא פענחו ידנית שורה אחת או מספר מילים מתוך הדף כדי ללמד את המודל את סגנון הכתב.</p>
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                   id="manualLine" type="text" placeholder="לדוגמה: והיה כי יביאך...">
        </div>

        <button onclick="runOCR()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline transition transform hover:scale-105">
            בצע פענוח
        </button>

        <div class="mt-8">
            <div class="loader" id="loader"></div>
            <div id="resultContainer" class="hidden">
                <label class="block text-gray-700 text-sm font-bold mb-2">תוצאה:</label>
                <textarea id="output" class="w-full h-64 p-4 border rounded bg-gray-50 text-right font-serif text-lg leading-relaxed" readonly></textarea>
                <button onclick="copyText()" class="mt-2 text-sm text-blue-500 hover:text-blue-700 underline">העתק טקסט</button>
            </div>
            <div id="errorMsg" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded border border-red-200 text-center"></div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>

    <script>
        // Preview Image Logic
        function previewImage(event) {
            const input = event.target;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imagePreview');
                    img.src = e.target.result;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Convert File to Base64 for Gemini
        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }

        // Main OCR Function
        async function runOCR() {
            const apiKey = document.getElementById('apiKey').value;
            const fileInput = document.getElementById('imageInput');
            const manualLine = document.getElementById('manualLine').value;
            const output = document.getElementById('output');
            const loader = document.getElementById('loader');
            const resultContainer = document.getElementById('resultContainer');
            const errorMsg = document.getElementById('errorMsg');

            // Validations
            if (!apiKey) { alert("אנא הכנס מפתח API"); return; }
            if (!fileInput.files[0]) { alert("אנא בחר תמונה"); return; }

            // UI Reset
            resultContainer.classList.add('hidden');
            errorMsg.classList.add('hidden');
            loader.style.display = 'block';
            output.value = '';

            try {
                const genAI = new window.GoogleGenerativeAI(apiKey);
                // שימוש במודל העדכני ביותר (ניתן לשנות כאן לגרסאות 3.0 כשיצאו רשמית)
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro" });

                const imagePart = await fileToGenerativePart(fileInput.files[0]);

                // בניית הפרומפט - הוראות מדויקות למודל
                let promptText = `
                תפקידך הוא לפענח כתב יד עתיק או קשה לקריאה מתוך תמונה ולהמיר אותו לטקסט דיגיטלי מדויק.
                הקפד על כל אות וסימן פיסוק. אל תוסיף פרשנות משלך, רק את הטקסט כפי שהוא מופיע.
                `;

                if (manualLine) {
                    promptText += `\n
                    כדי לעזור לך לזהות את סגנון הכתב, הנה שורה אחת מתוך הטקסט שפוענחה ידנית על ידי המשתמש. השתמש בה כרמז (Few-Shot Learning) לזיהוי שאר האותיות בדף:
                    "${manualLine}"
                    `;
                }

                promptText += `\nאנא פלט את הטקסט המלא של הדף כעת:`;

                const result = await model.generateContent([promptText, imagePart]);
                const response = await result.response;
                const text = response.text();

                output.value = text;
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                errorMsg.textContent = "שגיאה בפענוח: " + (error.message || "אנא ודא שה-API Key תקין ונסה שנית.");
                errorMsg.classList.remove('hidden');
            } finally {
                loader.style.display = 'none';
            }
        }

        function copyText() {
            const copyText = document.getElementById("output");
            copyText.select();
            document.execCommand("copy");
            alert("הטקסט הועתק ללוח");
        }
    </script>
</body>
</html>
